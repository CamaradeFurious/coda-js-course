import {
  fetchPokemonByGeneration,
  type PokemonListItem,
  fetchPokemonByName,
  type PokemonDetail,
} from "./api/pokemonApi";
import { renderPokemonList } from "./components/pokemon-list";
import { renderPokemonDetail } from "./components/pokemondetail";

const listContainer = document.getElementById("pokemon-list")!;
const detailContainer = document.getElementById("pokemon-detail")!;
const searchInput = document.getElementById("search") as HTMLInputElement;
const genSelect = document.getElementById("gen-select") as HTMLSelectElement;
const shinySelect = document.getElementById(
  "shiny-select"
) as HTMLSelectElement;

const teamListContainer = document.getElementById("team-list")!;
const saveTeamBtn = document.getElementById("save-team")!;
const loadTeamBtn = document.getElementById("load-team")!;

let allPokemon: PokemonListItem[] = [];
let timeout: number;
let currentDetail: PokemonDetail | null = null;
let team: PokemonDetail[] = [];

// --- LOAD GENERATION ---
async function loadGeneration(genId: number) {
  const list = await fetchPokemonByGeneration(genId);

  allPokemon = await Promise.all(
    list.map(async (p) => {
      const detail = await fetchPokemonByName(p.name);
      return {
        ...p,
        id: detail.id,
        nameFR: detail.nameFR,
        sprites: detail.sprites,
        types: detail.types,
      };
    })
  );

  allPokemon.sort((a, b) => (a.id || 0) - (b.id || 0));

  await renderPokemonList(
    listContainer,
    allPokemon,
    detailContainer,
    shinySelect.value === "true"
  );
}

// --- POKEMON DETAIL ---
async function showPokemonDetail(pokemon: PokemonDetail) {
  currentDetail = pokemon;
  renderPokemonDetail(pokemon, detailContainer, shinySelect.value === "true");
}

// --- NAVIGATION ---
async function navigatePokemon(direction: "next" | "prev") {
  if (!currentDetail) return;
  const index = allPokemon.findIndex(
    (p) => p.name === currentDetail!.nameFR.toLowerCase()
  );
  let newIndex = direction === "next" ? index + 1 : index - 1;
  if (newIndex < 0) newIndex = allPokemon.length - 1;
  if (newIndex >= allPokemon.length) newIndex = 0;
  const nextDetail = await fetchPokemonByName(allPokemon[newIndex].name);
  showPokemonDetail(nextDetail);
}

// --- RENDER TEAM ---
function renderTeam() {
  teamListContainer.innerHTML =
    team.length === 0
      ? "<p>Aucun Pok√©mon dans l'√©quipe</p>"
      : team
          .map(
            (p) => `
      <div class="team-card">
        <img src="${
          shinySelect.value === "true" ? p.sprites.shiny : p.sprites.normal
        }">
        <p>#${p.id} ${p.nameFR}</p>
        <button class="remove-btn" data-id="${p.id}">Supprimer</button>
      </div>
    `
          )
          .join("");

  teamListContainer.querySelectorAll(".remove-btn").forEach((btn) => {
    btn.addEventListener("click", (e) => {
      const id = Number(
        (e.currentTarget as HTMLButtonElement).dataset.id
      );
      team = team.filter((p) => p.id !== id);
      renderTeam();
    });
  });
}

// --- SAVE TEAM ---
function saveTeam() {
  localStorage.setItem(
    "myTeam",
    JSON.stringify(team.map((p) => ({ id: p.id, name: p.nameFR })))
  );
  alert("√âquipe sauvegard√©e !");
}

// --- LOAD TEAM ---
async function loadTeam(auto = false) {
  const saved = localStorage.getItem("myTeam");
  if (!saved) {
    if (!auto) alert("Aucune √©quipe sauvegard√©e !");
    renderTeam();
    return;
  }

  const savedPokemons: { id: number; name: string }[] = JSON.parse(saved);

  const details = await Promise.all(
    savedPokemons.map((p) => fetchPokemonByName(p.name))
  );

  team = details;
  renderTeam();
}

// --- ADD TO TEAM ---
function addToTeam(pokemon: PokemonDetail) {
  if (team.length >= 6) return alert("√âquipe compl√®te (6 Pok√©mon max)");
  if (team.find((p) => p.id === pokemon.id))
    return alert("Ce Pok√©mon est d√©j√† dans l'√©quipe !");
  team.push(pokemon);
  renderTeam();
}

// --- INIT ---
async function init() {
  await loadTeam(true); // üëà Auto load au d√©marrage
  await loadGeneration(parseInt(genSelect.value));

  searchInput.addEventListener("input", () => {
    clearTimeout(timeout);
    timeout = window.setTimeout(async () => {
      const search = searchInput.value.toLowerCase().trim();

      const filtered = allPokemon.filter((p) => {
        const french = (p.nameFR || "").toLowerCase();
        const idStr = p.id ? p.id.toString() : "";

        return french.includes(search) || idStr === search;
      });

      await renderPokemonList(
        listContainer,
        filtered,
        detailContainer,
        shinySelect.value === "true"
      );
    }, 400);
  });

  genSelect.addEventListener("change", async () => {
    await loadGeneration(parseInt(genSelect.value));
  });

  shinySelect.addEventListener("change", async () => {
    await renderPokemonList(
      listContainer,
      allPokemon,
      detailContainer,
      shinySelect.value === "true"
    );
    if (currentDetail) showPokemonDetail(currentDetail);
    renderTeam();
  });

  saveTeamBtn.addEventListener("click", saveTeam);
  loadTeamBtn.addEventListener("click", () => loadTeam(false));

  // Navigation clavier pour √©quipe
  document.addEventListener("keydown", async (e) => {
    if (!currentDetail) return;
    if (e.key === "ArrowRight") await navigatePokemon("next");
    if (e.key === "ArrowLeft") await navigatePokemon("prev");
    if (e.key === "a") addToTeam(currentDetail);
  });
}

init();
